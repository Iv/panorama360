/* panorama360 - plugin for jQuery
 * Copyright (c) 2011 Minimalistic Studio (http://minimalisticstudio.com/)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 * Thanks to: http://www.openstudio.fr for the initial idea.
 *
 * Some changes were made by evgeny g likov (http://likov.spb.ru): fixed drag and kinetic scroll (thanks man!)
 */
 (function($){$.fn.panorama360=function(o){this.each(function(){var b={start_position:0,image_width:0,image_height:0,mouse_wheel_multiplier:20,drag_factor:20,bind_resize:true};if(o)$.extend(b,o);var c=$(this);var d=c.children('.panorama-container');var f=d.children('img:first');if(b.image_width<=0&&b.image_height<=0){b.image_width=parseInt(f.data("width"));b.image_height=parseInt(f.data("height"));if(!(b.image_width)||!(b.image_height))return}var g=b.image_height/b.image_width;var h=parseInt(c.height());var i=parseInt(h/g);var j=f.attr('usemap');var k;var l=false;var m=0;var n=0;f.removeAttr("usemap").css("left",0).clone().css("left",i+"px").insertAfter(f);d.css({'margin-left':'-'+b.start_position+'px','width':(i*2)+'px','height':(h)+'px'});setInterval(function(){if(l)return false;n=n*0.98;if(Math.abs(n)<=2)n=0;scrollView(d,i,n)},1)c.mousedown(function(e){if(l)return false;$(this).addClass("grab");l=true;m=e.clientX;scrollOffset=0;return false}).mouseup(function(){$(this).removeClass("grab");l=false;n=n*0.45;return false}).mousemove(function(e){if(!l)return false;n=parseInt((e.clientX-m));m=e.clientX;scrollView(d,i,n);return false}).bind("mousewheel",function(e,a){delta=Math.ceil(Math.sqrt(Math.abs(a))),delta=a<0?-delta:delta;n=n+delta*5;scrollView(d,i,delta*b.mouse_wheel_multiplier);return false}).bind('contextmenu',stopEvent);if(j){$('map[name='+j+']').children('area').each(function(){switch($(this).attr("shape").toLowerCase()){case'rect':var a=$(this).attr("coords").split(",");$area1=$("<a class='area' href='"+$(this).attr("href")+"' title='"+$(this).attr("alt")+"'</a>");d.append($area1.data("stitch",1).data("coords",a));d.append($area1.clone().data("stitch",2).data("coords",a));break}});$('map[name='+j+']').remove();k=d.children(".area");k.mouseup(stopEvent).mousemove(stopEvent).mousedown(stopEvent);repositionHotspots(k,b.image_height,h,i)}if(b.bind_resize){$(window).resize(function(){h=parseInt(c.height());i=parseInt(h/g);d.css({'width':(i*2)+'px','height':(h)+'px'});f.css("left",0).next().css("left",i+"px");if(j)repositionHotspots(k,b.image_height,h,i)})}});function stopEvent(e){e.preventDefault();return false}function scrollView(a,b,c){var d=parseInt(a.css('marginLeft'))+c;if(d>0)d=-b;if(d<-b)d=0;a.css('marginLeft',d+'px')}function repositionHotspots(a,b,c,d){var e=c/b;a.each(function(){area_coord=$(this).data("coords");stitch=$(this).data("stitch");switch(stitch){case 1:$(this).css({'left':(area_coord[0]*e)+"px",'top':(area_coord[1]*e)+"px",'width':((area_coord[2]-area_coord[0])*e)+"px",'height':((area_coord[3]-area_coord[1])*e)+"px",});break;case 2:$(this).css({'left':(d+parseInt(area_coord[0])*e)+"px",'top':(area_coord[1]*e)+"px",'width':((area_coord[2]-area_coord[0])*e)+"px",'height':((area_coord[3]-area_coord[1])*e)+"px",});break}})}}})(jQuery);