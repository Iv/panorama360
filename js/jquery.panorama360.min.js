/* panorama360 - plugin for jQuery
 * Copyright (c) 2011 Minimalistic Studio (http://minimalisticstudio.com/)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 * Thanks to: http://www.openstudio.fr for the initial idea.
 *
 * Some changes were made by evgeny g likov (http://likov.spb.ru): fixed drag and kinetic scroll (thanks man!)
 */
 (function(a){a.fn.panorama360=function(c){this.each(function(){var h={start_position:0,image_width:0,image_height:0,mouse_wheel_multiplier:50,drag_factor:20,bind_resize:true};if(c){a.extend(h,c)}var n=a(this);var k=n.children(".panorama-container");var o=k.children("img:first");if(h.image_width<=0&&h.image_height<=0){h.image_width=parseInt(o.data("width"));h.image_height=parseInt(o.data("height"));if(!(h.image_width)||!(h.image_height)){return}}var j=h.image_height/h.image_width;var i=parseInt(n.height());var l=parseInt(i/j);var m=o.attr("usemap");var q;var g=false;var p=0;var f=0;o.removeAttr("usemap").css("left",0).clone().css("left",l+"px").insertAfter(o);k.css({"margin-left":"-"+h.start_position+"px",width:(l*2)+"px",height:(i)+"px"});setInterval(function(){if(g){return false}f=f*0.98;if(Math.abs(f)<=2){f=0}b(k,l,f)},1);n.mousedown(function(r){if(g){return false}a(this).addClass("grab");g=true;p=r.clientX;scrollOffset=0;return false}).mouseup(function(){a(this).removeClass("grab");g=false;f=f*0.5;return false}).mousemove(function(r){if(!g){return false}f=parseInt((r.clientX-p));p=r.clientX;b(k,l,f);return false}).bind("mousewheel",function(r,s){delta=Math.ceil(Math.sqrt(Math.abs(s))),delta=s<0?-delta:delta;b(k,l,delta*h.mouse_wheel_multiplier);return false}).bind("contextmenu",d);if(m){a("map[name="+m+"]").children("area").each(function(){switch(a(this).attr("shape").toLowerCase()){case"rect":var r=a(this).attr("coords").split(",");$area1=a("<a class='area' href='"+a(this).attr("href")+"' title='"+a(this).attr("alt")+"'</a>");k.append($area1.data("stitch",1).data("coords",r));k.append($area1.clone().data("stitch",2).data("coords",r));break}});a("map[name="+m+"]").remove();q=k.children(".area");q.mouseup(d).mousemove(d).mousedown(d);e(q,h.image_height,i,l)}if(h.bind_resize){a(window).resize(function(){i=parseInt(n.height());l=parseInt(i/j);k.css({width:(l*2)+"px",height:(i)+"px"});o.css("left",0).next().css("left",l+"px");if(m){e(q,h.image_height,i,l)}})}});function d(f){f.preventDefault();return false}function b(i,f,h){var g=parseInt(i.css("marginLeft"))+h;if(g>0){g=-f}if(g<-f){g=0}i.css("marginLeft",g+"px")}function e(g,f,j,h){var i=j/f;g.each(function(){area_coord=a(this).data("coords");stitch=a(this).data("stitch");switch(stitch){case 1:a(this).css({left:(area_coord[0]*i)+"px",top:(area_coord[1]*i)+"px",width:((area_coord[2]-area_coord[0])*i)+"px",height:((area_coord[3]-area_coord[1])*i)+"px",});break;case 2:a(this).css({left:(h+parseInt(area_coord[0])*i)+"px",top:(area_coord[1]*i)+"px",width:((area_coord[2]-area_coord[0])*i)+"px",height:((area_coord[3]-area_coord[1])*i)+"px",});break}})}}})(jQuery);